= Greger Client Module (GCM)
Eric Sandbling, https://github.com/ericsandbling
:toc:
:toclevels: 5
:sectnums:

This article describes the hardware and software of the *Greger Client Module (GCM)*. As well as the setup and installation process.

== Hardware

The hardware of the sensor hub is made up of a https://www.raspberrypi.org/[Raspberry Pi (RPi)] with a _RPi i2c 1-Wire Expansion Module_

.RPi i2c 1-Wire Expansion Module v1.1, provided by https://www.m.nu/[m.nu]
image::https://images.m.nu/data/product/1076f860/R-Pi-i2c-1wire-module.jpg[R-pi i2c 1wire expansion module v1.1]

=== 1-Wire Wiring

// Source: https://blog.m.nu/kontakteringsguide-1wire/

These wiring and contacting instructions applies to products provided by https://www.m.nu/[m.nu], except W-SERVER-ENET/WIFI and HA7Net, both from Embedded Data Systems.

To follow and understand these instructions, keep the socket with pins numbered 1-6(8) from left to right.

==== RJ12 splitter and 1-wire

A standard RJ12 splitter (_1-to-2_) are wired according to <<Digitrax Wiring Standards>>.

.Digitrax Wiring Standards.
image::http://www.railwaybob.com/Modules/WiringRJ12s/RJ12JackWires.jpg[Digitrax Wiring Standards]

Mapping between the Digitrax Wiring Standards (DWS,RJ12 Splitter) and a 1-Wire product is according to:

.1-Wire Wiring Mapping
|===
|Pin 2+|DWS 3+|1-Wire (RJ12) 3+|1-Wire (RJ45)

|1                   {set:cellbgcolor:auto}
|                    {set:cellbgcolor:white}
|White               {set:cellbgcolor:auto}
|                    {set:cellbgcolor:orange}
|Orange              {set:cellbgcolor:auto}
|PWR (+5v)           {set:cellbgcolor:auto}
|                    {set:cellbgcolor:palegreen}
|Green/White         {set:cellbgcolor:auto}
|GND (Power Return)  {set:cellbgcolor:auto}

|2                   {set:cellbgcolor:auto}
|                    {set:cellbgcolor:black}
|Black               {set:cellbgcolor:auto}
|                    {set:cellbgcolor:#ffd78e}
|Orange/White        {set:cellbgcolor:auto}
|GND (Power Return)  {set:cellbgcolor:auto}
|                    {set:cellbgcolor:green}
|Green               {set:cellbgcolor:auto}
|PWR (+5v)           {set:cellbgcolor:auto}

|3                   {set:cellbgcolor:auto}
|                    {set:cellbgcolor:Red}
|Red                 {set:cellbgcolor:auto}
|                    {set:cellbgcolor:blue}
|Blue                {set:cellbgcolor:auto}
|DQ (1-Wire Data)    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:#ffd78e}
|Orange/White        {set:cellbgcolor:auto}
|GND (Power Return)  {set:cellbgcolor:auto}

|4                   {set:cellbgcolor:auto}
|                    {set:cellbgcolor:green}
|Green               {set:cellbgcolor:auto}
|                    {set:cellbgcolor:lightblue}
|Blue/White          {set:cellbgcolor:auto}
|GND (1-Wire Return) {set:cellbgcolor:auto}
|                    {set:cellbgcolor:blue}
|Blue                {set:cellbgcolor:auto}
|DQ (1-Wire Data)    {set:cellbgcolor:auto}

|5                   {set:cellbgcolor:auto}
|                    {set:cellbgcolor:yellow}
|Yellow              {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:lightblue}
|Blue/White          {set:cellbgcolor:auto}
|GND (1-Wire Return) {set:cellbgcolor:auto}

|6                   {set:cellbgcolor:auto}
|                    {set:cellbgcolor:blue}
|Blue                {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:orange}
|Orange              {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}

|7                   {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:burlywood}
|Brown/White         {set:cellbgcolor:auto}
|+12v/+24v Unregulated  {set:cellbgcolor:auto}

|8                   {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:auto}
|                    {set:cellbgcolor:saddlebrown}
|Brown               {set:cellbgcolor:auto}
|GND (Power Return)  {set:cellbgcolor:auto}

|===

==== 1-Wire products with RJ12 contacting

The OW-SERVER-ENET/WIFI and HA7Net is powered on pin 6, and pin 2 is not connected. Data return and power return (GND) are shared on these products.

image::https://blog.m.nu/wp-content/uploads/2014/09/1-wire_kontaktering_rj12.jpg[Adaptor RJ12 (1-Wire)]

==== LED pulse detector

image::https://blog.m.nu/wp-content/uploads/2014/09/LED-pulsdetektor.png[LED pulse detector]

==== 1-Wire products with RJ45 contacting

image::https://blog.m.nu/wp-content/uploads/2014/09/1-wire_kontaktering_rj45.jpg[RJ45 1-Wire]

==== 1wire-produkter delivered before 2008-04-01

.Contactor on sensor cable.
image::http://blog.m.nu/wp-content/uploads/2014/09/1-wire_kontaktering_rj11_sensor.gif[Old Contactor on Sensor Cable]

.Contactor 2, attached to optional extension cable (contactor 1 is contacted according to <<Old Contactor on Sensor Cable, Contactor on Sensor Cable>>).
image::http://blog.m.nu/wp-content/uploads/2014/09/1-wire_kontaktering_rj11_adapter.gif[]

=== Alternative Hardware

==== Raspberry Pi Zero
i2c: https://www.abelectronics.co.uk/p/76/1-Wire-Pi-Zero[1 wire communication board for the RPi Zero]

[quote]
Smaller, cheaper... better? This needs further exploration.

== Software

// ToDo:
//
//  - Docker
//        https://www.raspberrypi.org/blog/docker-comes-to-raspberry-pi/
// https://blog.alexellis.io/getting-started-with-docker-on-raspberry-pi/
//
//  - 1-Wire File System (OWFS)
//      https://wiki.m.nu/index.php/OWFS_p%C3%A5_Rasperry_Pi
//      http://owfs.org/index.php?page=owfs

=== Headless Raspberry Pi Setup

==== Step 1: Download Raspian Image

Download the latest *Lite* Raspbian Image (_Stretch_) from https://www.raspberrypi.org/downloads/raspbian/.

[quote]
The Raspbian Stretch *Lite* image is the same as the *Desktop* image but contains only the bare minimum amount of packages.

==== Step 2: Write Image to SD card

Flash the SD card, see the official https://www.raspberrypi.org/documentation/installation/installing-images/README.md[Installation Instructions] available at the Raspberry Pi web page.

==== Step 3: Enable SSH on the SD card

Enable SSH by placing a file named `ssh` (without any extension) onto the boot partition of the SD card.

==== Step 4: Prepare (headless) WiFi

Create a file named `wpa_supplicant.conf` and place in the boot partition of the SD card.

This time you need to write a few lines of text for this file. For this file, you need to use the FULL VERSION of `wpa_supplicant.conf`. Meaning you must have the 3 lines of data namely ``country``, ``ctrl_interface`` and ``update_config``

.wpa_supplicant.conf
----
country="«your_ISO-3166-1_two-letter_country_code»"
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1

network={
   ssid="«your_SSID»"
   scan_ssid=1
   psk="«your_PSK»"
   key_mgmt=WPA-PSK
}
----

Replace ``«your_ISO-3166-1_two-letter_country_code»`` with your https://www.iso.org/obp/ui/#search/code/[ISO Country Code] (such as ``SE`` for Sweden), ``«your_SSID»`` with your wireless access point name and ``«your_PSK»`` with your Wi-Fi password.

NOTE::
The password can be configured either as the ASCII representation, in quotes as per the example above, or as a pre-encrypted 32 byte hexadecimal number. https://www.raspberrypi.org/documentation/configuration/wireless/wireless-cli.md[See Setting up WiFi via CLI *@* www.raspberrypi.org]

==== Step 5: Power up

Insert SD card into your RPi and power up.
